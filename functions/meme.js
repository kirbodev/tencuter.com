const randomMeme = require("../tools/randomMeme.js");
const sharp = require("sharp");

module.exports.handler = async (event, context, callback) => {
  try {
    const meme = await randomMeme();
    const memeSharp = await sharp(Buffer.from(meme, "base64"));
    const memeSharpResized = await memeSharp.resize(1080, 1080, {
        fit: "contain",
        background: { r: 0, g: 0, b: 0, alpha: 0 },
    }).png().toBuffer();
    const text = `<svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540 100" width="540" height="100"><style>.a{fill:#fff;stroke:#000}</style><path class="a" d="m30.6 49.2v-11.7h7.7v12.3q-0.1 4.6-3.2 7.5-3 3-10.2 3-7.3 0-10-2.8-2.7-2.9-2.7-7.5v-12.5h7.7v12q0 1.4 0.2 2.3 0.2 0.8 1.3 1.5 1.1 0.8 3.6 0.8 2.6 0 3.9-0.8 1.2-0.7 1.4-1.7 0.3-0.9 0.3-2.4zm20.2 11.1q-2.6 0-5.3-0.7-2.7-0.7-5-2.2l3.2-4.5q1.4 1.1 3.4 1.6 2.1 0.6 3.5 0.6 1.4 0 2.2-0.4 0.7-0.4 0.7-1 0-0.5-0.3-0.8-0.4-0.2-1.1-0.2-0.4 0-0.9 0-0.5 0-0.8 0-1.6 0.2-3.3 0.2-2.8 0-4.5-1-1.7-1-1.7-3.4 0-2.7 2.6-4.2 2.5-1.5 7.5-1.5 2.5 0 5 0.7 2.5 0.7 4.4 2.1l-3.6 3.5q-1.7-0.9-3.3-1.3-1.5-0.4-3.1-0.4-1.1 0-1.8 0.5-0.8 0.4-0.8 1 0 0.4 0.3 0.7 0.3 0.2 0.9 0.2 0.5 0 1.4-0.1 2.3-0.1 3.4-0.1 3.2 0 5 1 1.8 1.1 1.8 3.4 0 3.3-2.6 4.8-2.6 1.5-7.2 1.5zm32.2-8.1h-3.9-10.1q0.3 1.4 1.2 2.3 1 0.8 2.8 0.8 1.3 0 2.5-0.5 1.1-0.5 1.8-1.4 2.1 1 5.5 2.2-0.9 2.1-3.5 3.4-2.5 1.3-6.5 1.3-5.3 0-7.9-2.4-2.5-2.5-2.5-6.4 0-3.9 2.5-6.3 2.6-2.4 7.9-2.4 3.1 0 5.4 1 2.4 1.1 3.6 3 1.2 1.8 1.2 4.2 0 0.8 0 1.2zm-9.8-4.8q-1.6 0-2.6 0.6-0.9 0.6-1.4 1.6h7.4q-0.4-0.9-1.2-1.5-0.9-0.7-2.2-0.7zm28.2 12.9q-2.6 0-5.3-0.7-2.6-0.7-5-2.2l3.3-4.5q1.4 1.1 3.4 1.6 2 0.6 3.5 0.6 1.4 0 2.1-0.4 0.8-0.4 0.8-1 0-0.5-0.4-0.8-0.4-0.2-1-0.2-0.4 0-0.9 0-0.5 0-0.8 0-1.7 0.2-3.4 0.2-2.7 0-4.5-1-1.7-1-1.7-3.4 0-2.7 2.6-4.2 2.6-1.5 7.6-1.5 2.4 0 4.9 0.7 2.5 0.7 4.4 2.1l-3.5 3.5q-1.8-0.9-3.3-1.3-1.6-0.4-3.1-0.4-1.1 0-1.9 0.5-0.7 0.4-0.7 1 0 0.4 0.3 0.7 0.3 0.2 0.8 0.2 0.6 0 1.5-0.1 2.2-0.1 3.4-0.1 3.2 0 5 1 1.7 1.1 1.7 3.4 0 3.3-2.6 4.8-2.6 1.5-7.2 1.5zm23.4-22.5l-5.9 22.8h-7.7l5.9-22.8zm33.5 22.2h-7.3q0.3-4.1 0.3-8.4 0-1.4-0.7-2.2-0.7-0.8-1.9-0.8-1 0-1.8 1-0.7 0.9-0.7 2.6 0 5.5 0.1 7.8h-6.9q0.1-4.6 0.1-8.4 0-1.4-0.6-2.2-0.7-0.8-1.7-0.8-1.1 0-1.8 1-0.8 0.9-0.9 2.4 0 2.4 0 3.4 0 2.1 0.1 4.6h-7.4q0.2-4.5 0.2-8.4 0-4-0.2-8.5 2 0.1 3.1 0.1 1.1 0 3.1-0.1l1 4.6q0.7-2.5 2.2-3.7 1.6-1.2 3.6-1.2 2.4 0 3.9 1.3 1.6 1.3 1.9 3.5 0.8-2.2 2.4-3.5 1.7-1.3 3.8-1.3 2.8 0 4.4 1.9 1.6 1.8 1.6 5.1v5.1q0 3.5 0.1 5.1zm23-7.8l-3.8 0.1h-10.2q0.3 1.3 1.3 2.2 0.9 0.8 2.7 0.8 1.3 0 2.5-0.5 1.1-0.5 1.8-1.4 2.1 1 5.5 2.2-0.9 2.1-3.5 3.4-2.5 1.3-6.5 1.3-5.3 0-7.8-2.4-2.6-2.5-2.6-6.4 0-3.9 2.6-6.3 2.5-2.4 7.8-2.4 3.1 0 5.5 1 2.3 1.1 3.5 3 1.3 1.8 1.3 4.2 0 0.8-0.1 1.2zm-9.8-4.8q-1.6 0-2.5 0.6-1 0.6-1.4 1.6h7.3q-0.4-0.9-1.2-1.5-0.9-0.7-2.2-0.7zm43.3 12.6h-7.2q0.2-4.1 0.2-8.4 0-1.4-0.7-2.2-0.7-0.8-1.8-0.8-1.1 0-1.9 1-0.7 0.9-0.7 2.7v-0.1q0 5.5 0.1 7.8h-6.9q0.2-4.6 0.2-8.4 0-1.4-0.7-2.2-0.7-0.8-1.7-0.8-1.1 0-1.8 1-0.7 0.9-0.9 2.4 0 2.4 0 3.4 0 2.1 0.1 4.6h-7.4q0.2-4.5 0.2-8.4 0-4-0.2-8.5 2 0.1 3.1 0.1 1.2 0 3.1-0.1l1 4.6q0.7-2.5 2.2-3.7 1.6-1.2 3.6-1.2 2.4 0 3.9 1.3 1.6 1.3 2 3.5 0.7-2.2 2.3-3.5 1.7-1.3 3.9-1.3 2.8 0 4.3 1.9 1.6 1.8 1.6 5.1v5.1q0 3.5 0.1 5.1zm23-7.7h-3.8-10.1q0.2 1.3 1.2 2.2 1 0.8 2.8 0.8 1.3 0 2.4-0.5 1.2-0.5 1.8-1.4 2.1 1 5.6 2.2-1 2.1-3.6 3.4-2.5 1.3-6.5 1.3-5.3 0-7.8-2.4-2.5-2.5-2.5-6.4 0-3.9 2.5-6.3 2.5-2.4 7.8-2.4 3.1 0 5.5 1 2.3 1.1 3.5 3 1.3 1.8 1.3 4.2 0 0.8-0.1 1.3zm-9.8-4.9q-1.5 0-2.5 0.6-1 0.6-1.4 1.6h7.3q-0.4-0.9-1.2-1.5-0.9-0.7-2.2-0.7zm22.9-9.6l-6 22.8h-7.7l6-22.8zm15.3 5.3h7.2q-3.3 9-5.9 16.9h-9.7q-2.8-8.5-6-16.9h7.3l3.6 12.7zm12.6-1.8q-2 0-2.9-0.9-1-1-1-2.6 0-1.5 1-2.5 0.9-1 2.9-1 1.8 0 2.8 1.1 1 1 1 2.4 0 1.6-0.9 2.6-1 0.9-2.9 0.9zm3.8 18.8h-7.4q0.2-5 0.2-8.3 0-3.8-0.3-8.7h7.5q-0.3 4.7-0.3 8.7 0 3.4 0.3 8.3zm23-7.8h-3.8-10.1q0.2 1.4 1.2 2.3 1 0.8 2.8 0.8 1.3 0 2.4-0.5 1.2-0.5 1.9-1.5 2 1.1 5.5 2.2-1 2.2-3.5 3.5-2.5 1.3-6.6 1.3-5.3 0-7.8-2.4-2.5-2.5-2.5-6.5 0-3.8 2.5-6.2 2.5-2.5 7.8-2.5 3.2 0 5.5 1.1 2.3 1 3.6 2.9 1.2 1.9 1.2 4.3 0 0.8-0.1 1.2zm-9.8-4.8q-1.5 0-2.5 0.6-1 0.6-1.4 1.6h7.3q-0.3-1-1.2-1.6-0.8-0.6-2.2-0.6zm26.3-4.4l1.7 12.2 2.7-12.2h6.2l-3.5 17h-8.2l-2-7.9-2.2 7.9h-8l-3.4-17h6.2l2.6 12.2 1.8-12.2zm32.1 0.1v5.5q-2.9-0.2-5.3-0.3v3.3q0 1.7 0.7 2.6 0.8 1 2.6 1 0.7 0 1.4-0.2-0.1 1.2-0.1 2.4 0 0.5 0 2.5-1.3 0.3-2.3 0.3-0.9 0.1-2.4 0.1-3.6 0-5.1-1.8-1.5-1.7-1.5-4.9v-5.2q-1.4 0.1-3 0.2v-5.5q1.6 0 2.7-1 1.1-1 1.3-2.5h8.5q-1.6 2.2-3.5 3.5zm11.8 17.2q-5.3 0-7.8-2.4-2.5-2.5-2.5-6.5 0-3.8 2.5-6.2 2.5-2.5 7.8-2.5 3.6 0 6 1.2 2.4 1.2 3.5 3.1 1.2 2 1.2 4.4 0 4-2.7 6.5-2.6 2.4-8 2.4zm0.1-5.3q2.1 0 3-0.9 1-1 1-2.6 0-1.5-1-2.5-0.9-1-3-1-2 0-2.9 1-0.9 0.9-0.9 2.5 0 1.6 0.9 2.6 0.9 0.9 2.9 0.9zm32.8-8.6l0.8-3.4h5.9q-0.1 5.1-0.1 14.5 0 3.7-1.5 6-1.5 2.4-3.9 3.5-2.4 1-5.4 1-2.9 0-5.3-0.8-2.3-0.9-3.5-2.3l1.4-4.7q1.7 0.9 3.2 1.4 1.5 0.4 3.1 0.4 5.2 0 5.2-4.5 0-0.7 0.1-0.9 0-0.2 0-0.5 0-0.3 0-0.8-1.6 4.4-6.7 4.4-2.1 0-3.7-1.2-1.7-1.1-2.6-3-0.9-1.9-0.9-4.2 0-2.3 0.9-4.3 0.9-2 2.6-3.1 1.6-1.2 3.6-1.2 5.2 0 6.8 3.7zm-3.5 8.3q0.7 0 1.5-0.3 0.8-0.3 1.3-1.1 0.6-0.7 0.6-1.8 0-1.9-0.9-2.7-0.9-0.9-2.6-0.9-1.4 0-2.3 1-0.9 1-0.9 2.6 0 1.4 0.9 2.3 1 0.9 2.4 0.9zm22.7 5.6q-5.3 0-7.8-2.4-2.5-2.5-2.5-6.5 0-3.8 2.5-6.2 2.5-2.5 7.8-2.5 3.6 0 5.9 1.2 2.5 1.2 3.6 3.1 1.2 2 1.2 4.4 0 4-2.7 6.5-2.6 2.4-8 2.4zm0.1-5.3q2 0 3-0.9 1-1 1-2.6 0-1.5-1-2.5-1-1-3-1-2 0-2.9 1-1 0.9-1 2.5 0 1.6 1 2.6 0.9 0.9 2.9 0.9zm32.4-12.3q2.1 0 3.7 1.3 1.6 1.2 2.5 3.3 0.9 2.1 0.9 4.4 0 2.4-0.9 4.3-0.9 2-2.5 3.1-1.6 1.2-3.6 1.2-2.4 0-4.1-1-1.8-1-2.6-3.2l-0.9 3.9h-6q0.2-5.9 0.2-12.1 0-6.3-0.2-12h7l-0.1 3.8q-0.1 4-0.1 7.2 0.8-2.1 2.5-3.1 1.8-1.1 4.2-1.1zm-3.2 12.4q1.5 0 2.4-1 0.8-1 0.8-2.6 0-1.4-0.9-2.3-0.9-0.9-2.3-0.9-0.8 0-1.5 0.4-0.8 0.3-1.4 1-0.5 0.7-0.5 1.8 0 1.9 0.8 2.8 0.9 0.8 2.6 0.8zm32.7-4v3.7q0 1.1 0.2 1.5 0.3 0.4 1 0.6l-0.1 2.9q-1 0.2-1.8 0.3-0.7 0-1.9 0-2.6 0-3.5-1.2-0.9-1.2-0.9-3v-0.8q-0.9 2.5-2.6 3.8-1.7 1.2-4.4 1.2-3.1 0-4.7-1.2-1.5-1.3-1.5-3.7 0-2 1.3-3.2 1.3-1.1 4.1-1.5-2.3-1.7-4.7-3 1.9-2.3 4.3-3.5 2.4-1.3 5.8-1.3 4.7 0 7 2.1 2.4 2.1 2.4 6.3zm-8.8-2.9q-1.6 0-2.8 0.5-1.2 0.5-2.1 1.6 1.8-0.2 4.6-0.2 1.2 0 1.6-0.3 0.5-0.3 0.5-0.7 0-0.4-0.5-0.6-0.4-0.3-1.3-0.3zm-3.2 6.9q1.7 0 3.1-0.7 1.4-0.7 1.9-1.7v-0.8q-0.7 0.3-1.6 0.5-0.9 0.2-2.2 0.4l-1.1 0.2q-1.7 0.3-1.7 1.2 0 0.9 1.6 0.9zm21.4-3.6q0 1.6 0.9 2.6 1 0.9 2.9 0.9 1 0 1.8-0.4 0.8-0.4 1.5-1.1 2.6 1 6.2 1.7-1.1 2.4-3.5 3.7-2.4 1.4-6.3 1.4-5.2 0-7.7-2.4-2.4-2.5-2.4-6.4 0-3.9 2.4-6.3 2.5-2.5 7.7-2.5 3.9 0 6.3 1.4 2.4 1.3 3.5 3.7-2.8 0.6-6.2 1.8-0.7-0.8-1.5-1.2-0.8-0.4-1.8-0.4-1.9 0-2.9 1-0.9 0.9-0.9 2.5zm28.4-8.5h9.1l-7.7 7q3.9 5.6 7.3 10h-8.2l-1.6-2.6q-1.5-2.5-2-3.3l-2.6 2.3v3.6h-7.1q0.2-5.9 0.2-12 0-6-0.2-12.1h7.1v13.1q3-3.1 5.7-6z"/></svg>`;
    const textBuffer = Buffer.from(text);
    const image = await sharp(memeSharpResized).composite([
      { input: textBuffer, gravity: "southwest" },
    ])
    .toBuffer();
    callback(null, {
      statusCode: 200,
      headers: {
        "Content-Type": "image/png",
      },
      body: image.toString("base64"),
      isBase64Encoded: true,
    });
  } catch (e) {
    callback(null, {
      statusCode: 500,
      body: `Something went wrong: ${e}`,
    });
  }
};
