const fetch = require("node-fetch");
const sharp = require("sharp");

module.exports.handler = async (event, context, callback) => {
  try {
    // Get a random dog image
    const result1 = await fetch("https://cataas.com/cat?json=true");
    const resultURL = await result1.json();
    const result = await fetch(`https://cataas.com${resultURL.url}`);
    const buffer = await result.buffer();

    // Resize the image to 1080x1080
    const resizedBuffer = await sharp(buffer).resize(1080, 1080).toBuffer();

    // Add text to the image
    const text = `<svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540 100" width="540" height="100"><style>.a{fill:#fff;stroke:#000}</style><path class="a" d="m32.5 48.2v-12.9h8.4v13.5q0 5-3.4 8.3-3.3 3.2-11.3 3.2-8 0-10.9-3.1-3-3.1-2.9-8.1v-13.8h8.4v13.2q0 1.5 0.2 2.5 0.2 0.9 1.4 1.7 1.2 0.8 3.9 0.8 3 0 4.3-0.8 1.4-0.9 1.6-1.9 0.3-1 0.3-2.6zm22.1 12.1q-2.8 0-5.8-0.7-2.9-0.9-5.5-2.5l3.6-4.9q1.5 1.2 3.7 1.8 2.3 0.6 3.9 0.6 1.5 0 2.3-0.4 0.8-0.4 0.8-1.1 0-0.5-0.4-0.9-0.4-0.3-1.1-0.3-0.4 0-1 0.1-0.5 0-0.9 0-1.8 0.2-3.6 0.2-3 0-5-1.1-1.8-1.1-1.8-3.7 0-3 2.8-4.6 2.8-1.7 8.3-1.7 2.7 0 5.4 0.8 2.8 0.7 4.9 2.3l-3.9 3.9q-2-1-3.7-1.4-1.7-0.5-3.4-0.5-1.1 0-2 0.5-0.8 0.5-0.8 1.1 0 0.5 0.3 0.7 0.4 0.3 1 0.3 0.5 0 1.5-0.1 2.5-0.2 3.8-0.2 3.5 0 5.4 1.2 2 1.2 2 3.7 0 3.6-2.9 5.3-2.8 1.6-7.9 1.6zm35.3-8.8h-4.2-11.1q0.3 1.5 1.4 2.4 1.1 1 3 1 1.5 0 2.7-0.6 1.3-0.6 2-1.6 2.3 1.1 6.1 2.4-1.1 2.4-3.9 3.8-2.7 1.4-7.2 1.4-5.8 0-8.5-2.6-2.8-2.7-2.8-7.1 0-4.2 2.8-6.9 2.7-2.6 8.5-2.6 3.5 0 6 1.2 2.6 1.1 4 3.2 1.3 2 1.3 4.7 0 0.9-0.1 1.3zm-10.7-5.3q-1.7 0-2.8 0.7-1.1 0.6-1.5 1.7h8q-0.4-1-1.3-1.7-0.9-0.7-2.4-0.7zm31 14.1q-2.9 0-5.8-0.7-3-0.9-5.5-2.5l3.5-4.9q1.6 1.2 3.8 1.8 2.2 0.6 3.8 0.6 1.5 0 2.4-0.4 0.8-0.4 0.8-1.1 0-0.5-0.4-0.9-0.4-0.3-1.1-0.3-0.5 0-1 0.1-0.6 0-0.9 0-1.8 0.2-3.7 0.2-3 0-4.9-1.1-1.9-1.1-1.9-3.7 0-3 2.9-4.6 2.8-1.7 8.3-1.7 2.6 0 5.4 0.8 2.7 0.7 4.8 2.3l-3.9 3.9q-1.9-1-3.6-1.4-1.7-0.5-3.4-0.5-1.2 0-2 0.5-0.9 0.5-0.9 1.1 0 0.5 0.4 0.7 0.3 0.3 0.9 0.3 0.6 0 1.6-0.1 2.5-0.2 3.7-0.2 3.5 0 5.5 1.2 1.9 1.2 1.9 3.7 0 3.6-2.8 5.3-2.9 1.6-7.9 1.6zm25.6-24.7l-6.4 25.1h-8.5l6.5-25.1zm5.2 15.1q0.1 1.8 1.1 2.8 1.1 1.1 3.1 1.1 1.1 0 2-0.4 0.9-0.5 1.6-1.3 2.9 1.1 6.8 1.9-1.1 2.6-3.8 4.1-2.7 1.4-6.9 1.4-5.7 0-8.4-2.6-2.7-2.7-2.7-7 0-4.3 2.7-7 2.7-2.6 8.4-2.6 4.2 0 6.9 1.5 2.7 1.4 3.8 4-3 0.7-6.8 2-0.7-0.9-1.6-1.3-0.9-0.4-2-0.4-2 0-3.1 1-1 1.1-1.1 2.8zm38.9-0.4v4.1q0 1.1 0.3 1.6 0.3 0.5 1.1 0.7l-0.1 3.2q-1.1 0.1-1.9 0.2-0.8 0.1-2.1 0.1-3 0-3.9-1.3-1-1.3-1-3.4v-0.8q-1 2.8-2.9 4.1-1.8 1.4-4.8 1.4-3.4 0-5.1-1.4-1.7-1.3-1.7-4 0-2.2 1.5-3.5 1.4-1.3 4.5-1.7-2.6-1.9-5.2-3.2 2.1-2.6 4.7-3.9 2.6-1.4 6.3-1.4 5.3 0 7.8 2.3 2.5 2.2 2.5 6.9zm-9.5-3.2q-1.8 0-3.1 0.6-1.3 0.5-2.4 1.7 2.1-0.2 5.1-0.2 1.3 0 1.8-0.4 0.5-0.3 0.5-0.7 0-0.4-0.5-0.7-0.5-0.3-1.4-0.3zm-3.6 7.5q1.9 0 3.4-0.7 1.6-0.7 2.1-1.9v-0.9q-0.8 0.4-1.8 0.6-1 0.2-2.4 0.4l-1.2 0.3q-1.9 0.3-1.9 1.2 0 1 1.8 1zm31.9-13.1v6q-3.1-0.2-5.7-0.3v3.6q0 1.9 0.8 2.9 0.8 1 2.8 1 0.8 0 1.5-0.1-0.1 1.3-0.1 2.5 0 0.7 0.1 2.8-1.5 0.3-2.5 0.4-1.1 0-2.7 0-4 0-5.6-1.9-1.7-1.9-1.7-5.3l0.1-5.8q-1.6 0.1-3.4 0.2v-6q1.8 0 3-1.1 1.2-1.1 1.5-2.7h9.2q-1.7 2.4-3.8 3.8zm16.6-5.9l-6.5 25.1h-8.4l6.5-25.1zm16.8 5.8h7.9q-3.6 9.9-6.5 18.6h-10.6q-3.1-9.3-6.6-18.6h8l3.9 14zm13.8-2q-2.1 0-3.2-1-1-1.1-1-2.8 0-1.6 1-2.7 1.1-1.1 3.2-1.1 2.1 0 3.2 1.1 1.1 1.1 1.1 2.7 0 1.7-1.1 2.8-1.1 1-3.2 1zm4.2 20.6h-8.1q0.2-5.5 0.2-9 0-4.3-0.2-9.6h8.1q-0.2 5.1-0.2 9.6 0 3.7 0.2 9zm25.3-8.5h-4.2-11.1q0.3 1.5 1.3 2.5 1.1 0.9 3.1 0.9 1.4 0 2.7-0.6 1.2-0.5 2-1.6 2.3 1.2 6 2.4-1 2.4-3.8 3.9-2.7 1.3-7.2 1.3-5.8 0-8.6-2.6-2.7-2.7-2.7-7 0-4.3 2.7-6.9 2.8-2.7 8.6-2.7 3.5 0 6 1.2 2.6 1.1 3.9 3.2 1.4 2 1.4 4.7 0 0.9-0.1 1.3zm-10.7-5.3q-1.7 0-2.8 0.7-1.1 0.6-1.5 1.8h8q-0.4-1.1-1.3-1.8-1-0.7-2.4-0.7zm28.8-4.8l1.9 13.4 2.9-13.4h6.8l-3.8 18.6h-9.1l-2.1-8.7-2.4 8.7h-8.8l-3.8-18.6h6.8l2.9 13.3 2-13.3zm35.1 0.1v6q-3.1-0.2-5.7-0.3v3.6q0 1.9 0.8 2.9 0.8 1 2.8 1 0.8 0 1.5-0.1-0.1 1.3-0.1 2.6 0 0.6 0 2.7-1.4 0.3-2.5 0.4-1 0-2.6 0-4 0-5.7-1.9-1.6-1.9-1.6-5.3v-5.8q-1.6 0.1-3.3 0.2v-6q1.8 0 3-1.1 1.2-1.1 1.5-2.7h9.2q-1.7 2.4-3.8 3.8zm13 18.8q-5.9 0-8.6-2.6-2.7-2.7-2.7-7 0-4.3 2.7-6.9 2.7-2.7 8.6-2.7 3.9 0 6.5 1.3 2.6 1.3 3.9 3.4 1.3 2.2 1.3 4.9 0 4.3-3 7-2.9 2.6-8.7 2.6zm0.1-5.7q2.2 0 3.3-1.1 1.1-1 1.1-2.8 0-1.7-1.1-2.7-1.1-1.1-3.3-1.1-2.2 0-3.2 1-1.1 1.1-1.1 2.8 0 1.8 1.1 2.8 1 1.1 3.2 1.1zm35.9-9.5l0.9-3.7h6.5q-0.2 5.6-0.2 15.9 0 4-1.6 6.6-1.6 2.6-4.2 3.8-2.7 1.1-6 1.1-3.2 0-5.7-0.9-2.6-0.9-3.9-2.5l1.5-5.2q1.8 1.1 3.5 1.5 1.6 0.5 3.4 0.5 5.8 0 5.8-4.9 0-0.7 0-1 0-0.2 0-0.6 0-0.3 0-0.9-1.7 4.9-7.3 4.9-2.3 0-4.1-1.3-1.8-1.2-2.8-3.3-1-2.1-1-4.6 0-2.6 1-4.7 1-2.2 2.8-3.4 1.7-1.3 3.9-1.3 5.8 0 7.5 4zm-3.8 9.1q0.8 0 1.6-0.3 0.9-0.4 1.5-1.2 0.6-0.8 0.6-2 0-2.1-1-3-0.9-0.9-2.8-0.9-1.6 0-2.6 1.1-0.9 1.1-0.9 2.8 0 1.6 1 2.6 1.1 0.9 2.6 0.9zm24.9 6.1q-5.8 0-8.6-2.6-2.7-2.7-2.7-7 0-4.3 2.7-6.9 2.8-2.7 8.6-2.7 3.9 0 6.5 1.3 2.7 1.3 3.9 3.4 1.3 2.2 1.3 4.9 0 4.3-3 7-2.8 2.6-8.7 2.6zm0.1-5.7q2.2 0 3.3-1.1 1.1-1 1.1-2.8 0-1.7-1.1-2.7-1.1-1.1-3.3-1.1-2.2 0-3.2 1-1 1.1-1 2.8 0 1.8 1 2.8 1 1.1 3.2 1.1zm35.5-13.5q2.3 0 4.1 1.4 1.8 1.4 2.7 3.6 1 2.3 1 4.8 0 2.6-1 4.8-0.9 2.1-2.7 3.4-1.8 1.2-4 1.2-2.6 0-4.5-1-1.9-1.2-2.8-3.5l-1 4.2h-6.5q0.2-6.4 0.2-13.2 0-6.9-0.2-13.2h7.6l-0.1 4.1q-0.1 4.5-0.1 7.9 0.9-2.3 2.8-3.4 1.9-1.1 4.5-1.1zm-3.5 13.5q1.7 0 2.6-1.1 1-1 1-2.8 0-1.5-1.1-2.5-1-1-2.5-1-0.8 0-1.7 0.4-0.8 0.3-1.4 1.2-0.6 0.7-0.6 1.9 0 2.1 0.9 3.1 1 0.8 2.8 0.8zm35.8-4.3v4.1q0 1.1 0.3 1.6 0.3 0.5 1.1 0.7l-0.1 3.2q-1.1 0.1-1.9 0.2-0.8 0.1-2.1 0.1-3 0-3.9-1.3-1-1.3-1-3.4v-0.8q-1 2.8-2.9 4.1-1.8 1.4-4.8 1.4-3.4 0-5.1-1.4-1.7-1.3-1.7-4 0-2.2 1.5-3.5 1.4-1.3 4.5-1.7-2.6-1.9-5.2-3.2 2.1-2.6 4.7-3.9 2.6-1.4 6.3-1.4 5.3 0 7.8 2.3 2.5 2.2 2.5 6.9zm-9.5-3.2q-1.8 0-3.1 0.6-1.3 0.5-2.4 1.7 2.1-0.2 5.1-0.2 1.3 0 1.8-0.3 0.5-0.3 0.5-0.8 0-0.4-0.5-0.7-0.5-0.3-1.4-0.3zm-3.6 7.5q1.9 0 3.4-0.7 1.5-0.7 2.1-1.9v-0.9q-0.8 0.4-1.8 0.6-1 0.3-2.4 0.5l-1.2 0.2q-1.9 0.3-1.9 1.2 0 1 1.8 1zm23.4-3.9q0.1 1.8 1.1 2.8 1.1 1.1 3.1 1.1 1.1 0 2-0.4 0.9-0.5 1.7-1.3 2.9 1.1 6.7 1.9-1.1 2.6-3.8 4.1-2.6 1.4-6.9 1.4-5.7 0-8.4-2.6-2.7-2.7-2.7-7 0-4.3 2.7-6.9 2.7-2.7 8.4-2.7 4.3 0 6.9 1.5 2.7 1.4 3.8 4-3 0.7-6.7 2-0.8-0.9-1.7-1.3-0.9-0.4-2-0.4-2 0-3.1 1-1 1.1-1.1 2.8zm31.2-9.3h10l-8.4 7.7q4.3 6.1 8 10.9h-9l-1.7-2.8q-1.7-2.8-2.3-3.7l-2.8 2.6v3.9h-7.8q0.3-6.5 0.3-13.1 0-6.6-0.3-13.3h7.8v14.4q3.3-3.4 6.2-6.6z"/></svg>`;
    const textBuffer = Buffer.from(text);

    const image = await sharp(resizedBuffer)
      .composite([{ input: textBuffer, gravity: "southwest" }])
      .toBuffer();

    callback(null, {
      statusCode: 200,
      headers: {
        "Content-Type": "image/png",
      },
      body: image.toString("base64"),
      isBase64Encoded: true,
    });
  } catch (e) {
    callback(null, {
      statusCode: 500,
      body: `Something went wrong: ${e}`,
    });
  }
};
